---
title: "Data Exploration Project"
author: "Glen Lewis"
date: "2/18/2021"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# base library and data build ---- 
library(tidyverse)
library(jtools)
library(vtable)
library(purrr)
library(lubridate)

base_institute_data <- read_csv('01_raw_data/Most+Recent+Cohorts+(Scorecard+Elements).csv') 

# function build ----
trend_prep <- function(df) {
  'schname' = select(df, schname, monthorweek, index)
  return(tibble(schname))
}


class_conversion <- function(df, x, y){
  'str_prefix' = x
  'new_class' = y
  df %>% mutate(across(starts_with(str_prefix), new_class))
}

# builds and cleans the trend data WIP = Work in Progress----

# builds the base trend df 
trend_filenames <- list.files('01_raw_data', 'trend', full.name = TRUE)

base_trend <- trend_filenames %>% 
  map(read_csv) %>% 
  map(trend_prep) %>% 
  bind_rows() %>% 
  na.omit()

# mutates the trend by extracting the beginning week dates of 'monthorweek' df

wip_trend<- base_trend %>% mutate(week_start = as.Date(str_sub(monthorweek,1,10))) %>% 
  mutate(year = year(week_start), month = month(week_start)) %>% 
  select(-'monthorweek')

# generates the index standard deviation and mean needed to standardizes 
# individual index scores

index_sd <- wip_trend %>% pull(index) %>% na.omit %>% sd()
index_mean <- wip_trend %>% pull(index) %>% na.omit %>% mean()

# mutates the trend WIP df by first grouping by schname to derive weekly 
# standardized index scores. Then grouping by schname, year, month to up level 
# the weekly index scores to a monthly 'average' index score and standardized score.  

wip_trend <- wip_trend %>% group_by(schname) %>% 
  mutate(stdzed_index_score = (index - index_mean) / index_sd) 

wip_trend <- wip_trend %>% group_by(schname, year, month) %>% 
  mutate(monthly_av_index_score = mean(index), 
  monthly_av_stdzed_index_score = mean(stdzed_index_score))

write_csv(wip_trend, path = '02_derived_data/wip_trend.csv')

# build and cleans the institute data ----
wip_institute_data <- base_institute_data

names(wip_institute_data)[121] <- 'md_earn_wne_p10'

# following coverts character columns to appropriate class
wip_institute_data$gt_25k_p6 <- as.numeric(wip_institute_data$gt_25k_p6) #float

wip_institute_data <- wip_institute_data %>% class_conversion("NPT", as.numeric) %>% 
  class_conversion("PCIP", as.numeric) %>% 
  #integer or float 
  class_conversion("md_", as.numeric) #integer or float 

wip_institute_data <- wip_institute_data %>% class_conversion(c('HBCU', 'PBI', 'ANNHI',
     'TRIBAL', 'AANAPII', 'HSI', 'NANTI', 'MENONLY', 'WOMENONLY'), as.factor)

earning_sd <- wip_institute_data %>% pull(md_earn_wne_p10) %>% na.omit() %>% sd()
mean_earning <- wip_institute_data %>% pull(md_earn_wne_p10) %>% na.omit() %>% mean()

wip_institute_data<- wip_institute_data %>% 
  mutate(sd_earnings = (md_earn_wne_p10 - mean_earning) / earning_sd)

# following code jinks the data into a single dataframe ----
base_name_id <- read_csv('01_raw_data/id_name_link.csv')

wip_id_index <- base_name_id %>% left_join(wip_trend, 'schname') %>% 
  rename(OPEID = opeid) %>% select(-'unitid', -'schname')

wip_institute_data <- wip_institute_data %>% full_join(wip_id_index, 'OPEID')

# following code builds specific dataframes for analysis ----

pre_2015_hi <- wip_institute_data %>% filter(year < 2015, sd_earnings > .786) 
pre_2015_low <- wip_institute_data %>% filter(year < 2015, sd_earnings < - 0.159)

post_2015_hi <- wip_institute_data %>% filter(year > 2014, sd_earnings > .786)
post_2015_low <- wip_institute_data %>% filter(year > 2014, sd_earnings < - 0.159)

```
The U.S. Department of Education published the first College Score Card in 2015. This score card included the once hard to find metric: post-graduation earning, the earnings alumni reported 10 years after graduation ('earnings' for this analysis). The following examines if schools' whose graduates earned more received more interest from perspective students following publication of the first score card.

H~0~ = College Score Card publication had no impact on perspective student interest in High Earning Schools
H~a~ = Publication of the College Score Card increased interest in High Earning Schools whose graduates earned more

## Defining High and Low 'Earning' Schools

The first challenge is defining low and high earning institutions. Initial visualization and descriptive statistics show reported graduate earnings interquartile range being -.159 to .786 standard deviations (std) from the mean earnings. For the purposes of this analysis, therefore, we define high earning schools as those whose graduates reported earnings above the 75th percentile (.786) and conversely, we defined low earning schools   as those schools whose graduates reported below the 25th percentile (-.159).

```{r}
ggplot(wip_institute_data, aes(x = sd_earnings)) + 
  geom_boxplot() + 
  xlab('Standardized Earnings') +
  theme(axis.text.y = element_blank(),
  axis.ticks = element_blank()) 
```

## Did Graduate Reported Earnings Influence Index Scores Prior to 2015?

The visualizations and models show that prior to 2015, for schools with high earnings, there is an identifiable relationship between their higher earnings and their index score. 

In the “High Earning Institute Std Index Prior to 2015” most of the schools and the largest variations in index scores are between .789 and 2.5 std (~$44300 - ~$68500) in earnings and centered on 0.  As reported earnings increased the number of schools decrease as expected with variation also decreasing remaining generally within +/- 1 index score std the average index score. There was one outlier at above 7.5 std (~$138,000) whose sore scores averaged ~.5 std deviations below the average. 

If variation of the index scores represents the ebbs and flows of perspective students’ interest throughout the year and if higher earnings drove interest in a particular school (as represented by the index score) you would expect higher earning schools to:

1.	Have larger variations as both qualified and unqualified students investigated the potential for attendance. In this case variation is consistent for high earning school sat +/- .5 std. 
2.	The average index score for higher earning institutes would consistently be above the average index score for all schools. While some high earning schools’ index score are consistently above the average there are also several that have average or below average index scores.

```{r}
ggplot(pre_2015_hi, aes(x = sd_earnings, y = monthly_av_stdzed_index_score)) + 
  geom_point() +
  xlab('Standardized Earnings') +
  ylab('Monthly Standardized Index Score') +
  ggtitle('High Earning Institiutes Monthly Std Index, Prior to 2015')

ggplot(pre_2015_low, aes(x = sd_earnings, y = monthly_av_stdzed_index_score)) + 
  geom_point() +
  xlab('Standardized Earnings') +
  ylab('Monthly Standardized Index Score') +
  ggtitle('Low Earning Institiutes Monthly Std Index, Prior to 2015') 
```

Two different models where examined: 

1.	a “straight” model of monthly average standardized index score against the standardizes earning for each school for 2013 and 2014.
2.	a “polynomial” model of the same variables. The polynomial was intended to address the outliers.
3.	a “month” control variable since interest in schools is seasonal, i.e., interest increases and wanes in the spring and summer as students begin the application process for their first fall classes.

The “straight” regression model (st_pre_2015_hi_lm) supported the notion that earnings had only a small little to no relationship with index scores prior to 2015 showing that an increase one 1 standard deviation increased index score by .01. The effects plot shows a coeffect nicely includes index scores below 7.5 standard deviation but “downplays” the effect of schools above 7.5. 

The “polynomial” regression model (poly_pre_2015_hi_lm) supported the observation that for an increase in standardized earnings there is a .18 increase in index score until approximately 3 standard deviations (B~1~/(2B~2~), ~$75500) when the index score decreases by .03 for a 1 standard deviation increase in earnings. This makes sense as some these higher earning schools could be specialty schools that apply to a small segment of the overall prospective student population. 

````{r}
st_pre_2015_hi_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + month, data = pre_2015_hi)
poly_pre_2015_hi_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + I(sd_earnings^2) + month, data = pre_2015_hi)
pre_2015_low_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + month, data = pre_2015_low)
export_summs(st_pre_2015_hi_lm, poly_pre_2015_hi_lm, pre_2015_low_lm, model.names = c('pre_2015_hi_lm', 'poly_pre_2015_hi_lm', 'pre_2015_low_lm'))
effect_plot(st_pre_2015_hi_lm, sd_earnings, plot.points = TRUE, x.label = 'Standardized Earnings', y.label =  'Monthly Standardized Index Scores', point.color = 'blue2', main.title = "Straight pre 2015 Model")
effect_plot(poly_pre_2015_hi_lm, sd_earnings, plot.points = TRUE, x.label = 'Standardized Earnings', y.label =  'Monthly Standardized Index Scores', point.color = 'blue2', main.title = "Polynomial pre 2015 Model")
````
 
# Index Scores After to 2015

The visualizations after 2015, appears to show an interesting change on the potential relationship between higher earnings schools and their index score. In the “High Earning Institute Std Index Post 2015” there is a noticeable shift toward negative standardized index scores for all schools between .789 and 2.5 std deviations (~$44300 - ~$68500). Additionally, the variation in index score for schools above 5 std in earnings (~$104000) indicating a more consistent interest year-round.  Their index score; however, remained mostly +/- 1 std of the average score. Thus, there is no notability difference in the high earning scores from the average which one would expect if earnings played a significant role in index scores. 

````{r}
ggplot(post_2015_hi, aes(x = sd_earnings, y = monthly_av_stdzed_index_score)) + 
  geom_point() +
  xlab('Standardized Earnings') +
  ylab('Monthly Standardized Index Score') +
  ggtitle('High Earning Institiutes Monthly Std Index, Post 2015')
ggplot(post_2015_low, aes(x = sd_earnings, y =monthly_av_stdzed_index_score)) + 
  geom_point() +
  xlab('Standardized Earnings') +
  ylab('Monthly Standardized Index Score') +
  ggtitle('Low Earning Institiutes Monthly Std Index, Post 2015') 

poly_post_2015_hi_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + I(sd_earnings^2) +  month, data = post_2015_hi)
post_2015_low_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + month, data = post_2015_low)
export_summs(poly_post_2015_hi_lm, post_2015_low_lm, model.names = c('poly_post_2015_hi_lm', 'post_2015_low_lm'))
effect_plot(poly_post_2015_hi_lm, sd_earnings, plot.points = TRUE, x.label = 'Standardized Earnings', y.label =  'Monthly Standardized Index Scores', point.color = 'blue2', main.title = "Polynomial post 2015 Model")
````
Only one model, the pre_2015_hi_lm model was used to model the behavior of index scores for low earning schools.  That is due to the poor fit for a polynomial.  The model also shows a strong, statically significant relationship between increases in reported earnings and index score for those schools considered ad low earners. The model pre_2015_low_lm shows that for .1 increase (~$1400) in standardized earnings, there is a .18 increase in interest.

The visualizations after 2015, appears to show an interesting change on the potential relationship between higher earnings schools and their index score. In the “High Earning Institute Std Index Post 2015” there is a noticeable shift toward negative standardized index scores for all schools, and especially noticeable for schools between .789 and 2.5 std deviations (~$44300 - ~$68500). While high earning schools saw a negative shift in their index score; remained mostly +/- 1 std of the average score. Thus, there is no notability difference in the high earning scores from the average index which one would expect if earnings played a significant role in index scores.

The polynomial model supports this. Both models’ intercepts are lower than the pre 2015 models while there is no change in the post 2015 B1, B2 coefficients in the polynomial model.

The post 2015 low earning school model had a significant change with the change in index score verse increases in standardized earnings being only .08 verses the pre 2015 of .18.

````{r}
poly_post_2015_hi_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + I(sd_earnings^2) +  month, data = post_2015_hi)
post_2015_low_lm <- lm(monthly_av_stdzed_index_score ~ sd_earnings + month, data = post_2015_low)
export_summs(poly_post_2015_hi_lm, post_2015_low_lm, model.names = c('poly_post_2015_hi_lm', 'post_2015_low_lm'))
effect_plot(poly_post_2015_hi_lm, sd_earnings, plot.points = TRUE, x.label = 'Standardized Earnings', y.label =  'Monthly Standardized Index Scores', point.color = 'blue2', main.title = "Polynomial post 2015 Model")
````

# Conclusion

The data above indicates that publication of the College Score Card and its report on graduate earnings did not have an influence on the college index scores. 

There was a noticeable negative shift in index scores indicating a reduced interest in the report's schools following 2015.  That shift could be the result of other effects outside of the score card, such as the increase entollment in vocational schools teaching skills that were once required four year degrees.  
